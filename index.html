<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ContractorOS — Full Demo</title>
<link rel="manifest" href="/manifest.webmanifest">
<style>
body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:980px;margin:40px auto;padding:0 16px}
.card{background:rgba(17,24,39,.7);backdrop-filter:blur(10px);border:1px solid rgba(148,163,184,.2);border-radius:16px;padding:20px;margin-bottom:20px}
textarea,input,button{font:inherit}textarea,input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:#e5e7eb}
button{padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:#e5e7eb;cursor:pointer}
.primary{background:linear-gradient(90deg,#0891b2,#06b6d4);border:none;color:#001016;font-weight:600}
table{width:100%;border-collapse:collapse;margin-top:8px}th,td{padding:10px;border-bottom:1px dashed rgba(148,163,184,.25);text-align:left;font-size:14px}
.right{text-align:right}.muted{color:#94a3b8}.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 280px}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.3);font-size:12px;color:#93c5fd}
</style>
<script>if("serviceWorker" in navigator){addEventListener("load",()=>navigator.serviceWorker.register("/sw.js"))}</script>
</head>
<body><div class="wrap">
  <div class="card">
    <h1>ContractorOS — Full Demo</h1>
    <small>API: <span id="api" class="pill"></span> • Status: <span id="status" class="pill">checking…</span></small>
    <div class="row" style="margin-top:12px">
      <div class="col"><input id="zip" placeholder="ZIP / Postal" value="78413"></div>
    </div>
    <label>Ask for materials in plain English</label>
    <textarea id="query" rows="5" placeholder="e.g. need 20 4x4x8 posts and 10 bags quikrete 50 lb"></textarea>
    <div class="row" style="margin-top:12px">
      <button class="primary" onclick="search()">Smart Search</button>
      <button onclick="demo()">Load demo</button>
    </div>
  </div>

  <div class="card">
    <h2>Photo / Screenshot</h2>
    <input id="img" type="file" accept="image/*,application/pdf">
    <button onclick="analyze()">Analyze Photo</button>
    <div id="imgStatus" class="muted" style="margin-top:8px"></div>
  </div>

  <div id="resultsCard" class="card" style="display:none">
    <h2>Offers</h2>
    <div id="offers"></div>
  </div>
</div>

<script>
const API="https://contractoros-backend.onrender.com"; // change if your Render URL is different
document.getElementById("api").innerText=API;

(async()=>{try{const r=await fetch(API+"/health");const j=await r.json();document.getElementById("status").innerText=j.ok?"online":"issue"}catch(e){document.getElementById("status").innerText="offline"}})();

function rowHtml(item, offers){
  let html = `<div style='margin:10px 0'><strong>${item.name}</strong> • Qty ${item.qty} ${item.unit||""}</div>`;
  html += `<table><tr><th>Vendor</th><th class='right'>Unit $</th><th class='right'>Ext.</th><th>Source</th></tr>`;
  (offers||[]).forEach(o=>{ const ext=(o.price||0)*(item.qty||0);
    html += `<tr><td>${o.store||"-"}</td><td class='right'>$${(o.price||0).toFixed(2)}</td><td class='right'>$${ext.toFixed(2)}</td><td>${o.source||"catalog"}</td></tr>`; });
  html += `</table>`; return html;
}

async function search(){
  const zip=document.getElementById("zip").value||"78413";
  const query=document.getElementById("query").value;
  const j=await fetch(API+"/analyze_text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query,zip})}).then(r=>r.json());
  const priced=await fetch(API+"/price",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:j.items,zip})}).then(r=>r.json());
  let html=""; (priced.results||[]).forEach(row=>{ html += rowHtml(row.item, row.offers); });
  document.getElementById("offers").innerHTML = html || "No offers.";
  document.getElementById("resultsCard").style.display="block";
}

function demo(){
  document.getElementById("zip").value="78413";
  document.getElementById("query").value="need 20 4x4x8 posts and 10 bags quikrete 50 lb";
}

async function analyze(){
  const f=document.getElementById("img").files[0];
  if(!f){ alert("Choose an image or PDF first"); return; }
  const zip=document.getElementById("zip").value||"78413";
  const fd=new FormData(); fd.append("file", f); fd.append("zip", zip);
  document.getElementById("imgStatus").innerText="Analyzing…";
  try{
    const j = await fetch(API+"/analyze_image",{method:"POST",body:fd}).then(r=>r.json());
    document.getElementById("imgStatus").innerText="Parsed. Getting offers…";
    const priced=await fetch(API+"/price",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:j.items,zip})}).then(r=>r.json());
    let html=""; (priced.results||[]).forEach(row=>{ html += rowHtml(row.item, row.offers); });
    document.getElementById("offers").innerHTML = html || "No offers.";
    document.getElementById("resultsCard").style.display="block";
    document.getElementById("imgStatus").innerText="";
  }catch(e){ document.getElementById("imgStatus").innerText="Error: "+e.message; }
}
</script>
</body></html>
